<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZKP èªè­‰ç®¡ç†ç³»çµ±</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px; 
      max-width: 1000px; 
      margin: auto; 
      background-color: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1, h2 { color: #333; margin-bottom: 20px; }
    h1 { border-bottom: 3px solid #dc3545; padding-bottom: 10px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    button {
      font-size: 1rem;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    
    button:hover:not(:disabled) { transform: translateY(-2px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1rem;
    }
    
    input:focus, textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    .log-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background: #f8f9fa;
    }
    
    .log-entry {
      margin-bottom: 10px;
      padding: 10px;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #007bff;
    }
    
    .log-entry.revoked {
      border-left-color: #dc3545;
    }
    
    .log-timestamp {
      color: #6c757d;
      font-size: 0.8rem;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #f5c6cb;
      margin-bottom: 15px;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #c3e6cb;
      margin-bottom: 15px;
    }
    
    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #ffeaa7;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ›¡ï¸ ZKP èªè­‰ç®¡ç†ç³»çµ±</h1>
    
    <div class="warning">
      <strong>âš ï¸ ç®¡ç†å“¡å°ˆç”¨ï¼š</strong> æ­¤å·¥å…·ç”¨æ–¼ç®¡ç† Zero Knowledge Proof èªè­‰ç³»çµ±ï¼ŒåŒ…æ‹¬æŸ¥çœ‹çµ±è¨ˆè³‡æ–™å’Œæ’¤éŠ·æƒ¡æ„ç”¨æˆ¶çš„èªè­‰ã€‚
    </div>

    <!-- çµ±è¨ˆè³‡æ–™ -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-number" id="totalIdentities">-</div>
        <div class="stat-label">ç¸½è¨»å†Šèº«åˆ†</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeIdentities">-</div>
        <div class="stat-label">æ´»èºèº«åˆ†</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="revokedIdentities">-</div>
        <div class="stat-label">å·²æ’¤éŠ·èº«åˆ†</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalProofs">-</div>
        <div class="stat-label">ç¸½ Proof æ•¸é‡</div>
      </div>
    </div>

    <div style="text-align: center; margin-bottom: 30px;">
      <button class="btn-primary" onclick="loadStats()">ğŸ”„ é‡æ–°è¼‰å…¥çµ±è¨ˆ</button>
      <button class="btn-success" onclick="checkHealth()">ğŸ’š æª¢æŸ¥æœå‹™ç‹€æ…‹</button>
    </div>
  </div>

  <div class="container">
    <h2>ğŸš« æ’¤éŠ·ç”¨æˆ¶èªè­‰</h2>
    
    <div class="warning">
      <strong>æ³¨æ„ï¼š</strong> æ’¤éŠ·èªè­‰å¾Œï¼Œè©²ç”¨æˆ¶å°‡ç„¡æ³•å†ä½¿ç”¨ç³»çµ±ï¼Œæ­¤æ“ä½œä¸å¯é€†ã€‚
    </div>

    <form id="revokeForm">
      <div class="form-group">
        <label for="commitment">Commitmentï¼ˆç”¨æˆ¶èº«åˆ†è­˜åˆ¥ç¢¼ï¼‰:</label>
        <input type="text" id="commitment" placeholder="è«‹è¼¸å…¥è¦æ’¤éŠ·çš„ commitment" required>
        <small style="color: #6c757d; font-size: 0.8rem;">
          * å¯å¾ç³»çµ±æ—¥èªŒæˆ–æƒ¡æ„è¡Œç‚ºå ±å‘Šä¸­å–å¾—æ­¤è­˜åˆ¥ç¢¼
        </small>
      </div>
      
      <div class="form-group">
        <label for="reason">æ’¤éŠ·åŸå› :</label>
        <textarea id="reason" rows="3" placeholder="è«‹èªªæ˜æ’¤éŠ·åŸå› ï¼ˆä¾‹å¦‚ï¼šæƒ¡æ„æª¢èˆ‰ã€æ¿«ç”¨ç³»çµ±ç­‰ï¼‰" required></textarea>
      </div>
      
      <button type="submit" class="btn-danger">ğŸš« æ’¤éŠ·èªè­‰</button>
    </form>
  </div>

  <div class="container">
    <h2>ğŸ“‹ æ“ä½œæ—¥èªŒ</h2>
    <div class="log-container" id="logContainer">
      <div style="text-align: center; color: #6c757d;">
        è¼‰å…¥ä¸­...
      </div>
    </div>
  </div>

  <div class="container">
    <h2>ğŸ“‹ æª¢èˆ‰äººè¨˜éŒ„æŸ¥è©¢</h2>
    
    <div class="warning">
      <strong>èªªæ˜ï¼š</strong> æ­¤åŠŸèƒ½ç”¨æ–¼æŸ¥è©¢æª¢èˆ‰äººçš„åŒ¿åèº«åˆ†è¨˜éŒ„ï¼Œå³ä½¿ä¸çŸ¥é“æª¢èˆ‰äººçœŸå¯¦èº«åˆ†ï¼Œä¹Ÿèƒ½æ ¹æ“š commitment é€²è¡Œç®¡ç†ã€‚
    </div>
    
    <div style="margin-bottom: 20px;">
      <button class="btn-primary" onclick="loadReporterRecords()">ğŸ“Š è¼‰å…¥æ‰€æœ‰æª¢èˆ‰äººè¨˜éŒ„</button>
      <button class="btn-success" onclick="exportRecords()">ğŸ’¾ åŒ¯å‡ºè¨˜éŒ„</button>
    </div>
    
    <div class="form-group">
      <label for="searchCommitment">ğŸ” æœå°‹ç‰¹å®šæª¢èˆ‰äºº (Commitment):</label>
      <input type="text" id="searchCommitment" placeholder="è«‹è¼¸å…¥ commitment æœå°‹ç‰¹å®šæª¢èˆ‰äººçš„æ‰€æœ‰è¨˜éŒ„">
      <button class="btn-primary" onclick="searchReporter()" style="margin-top: 10px;">ğŸ” æœå°‹</button>
    </div>
    
    <div id="reporterRecords" class="log-container">
      <div style="text-align: center; color: #6c757d;">
        é»æ“Šã€Œè¼‰å…¥æ‰€æœ‰æª¢èˆ‰äººè¨˜éŒ„ã€æŸ¥çœ‹è¨˜éŒ„
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api/zkp';
    let operationLog = [];

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadStats();
      checkHealth();
      
      // ç¶å®šæ’¤éŠ·è¡¨å–®äº‹ä»¶
      document.getElementById('revokeForm').addEventListener('submit', handleRevoke);
    });

    /**
     * è¼‰å…¥çµ±è¨ˆè³‡æ–™
     */
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/stats`);
        const stats = await response.json();
        
        if (response.ok) {
          document.getElementById('totalIdentities').textContent = stats.totalIdentities;
          document.getElementById('activeIdentities').textContent = stats.activeIdentities;
          document.getElementById('revokedIdentities').textContent = stats.revokedIdentities;
          document.getElementById('totalProofs').textContent = stats.totalProofs;
          
          addLog('success', 'çµ±è¨ˆè³‡æ–™è¼‰å…¥æˆåŠŸ');
        } else {
          throw new Error(stats.error || 'è¼‰å…¥çµ±è¨ˆå¤±æ•—');
        }
      } catch (error) {
        console.error('è¼‰å…¥çµ±è¨ˆéŒ¯èª¤:', error);
        addLog('error', 'è¼‰å…¥çµ±è¨ˆå¤±æ•—: ' + error.message);
      }
    }

    /**
     * æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹
     */
    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        const health = await response.json();
        
        if (response.ok) {
          addLog('success', `ZKP æœå‹™é‹è¡Œæ­£å¸¸ - ${health.service}`);
        } else {
          throw new Error('æœå‹™ç•°å¸¸');
        }
      } catch (error) {
        console.error('å¥åº·æª¢æŸ¥éŒ¯èª¤:', error);
        addLog('error', 'ZKP æœå‹™é€£æ¥å¤±æ•—: ' + error.message);
      }
    }

    /**
     * è™•ç†æ’¤éŠ·èªè­‰
     */
    async function handleRevoke(e) {
      e.preventDefault();
      
      const commitment = document.getElementById('commitment').value.trim();
      const reason = document.getElementById('reason').value.trim();
      
      if (!commitment || !reason) {
        addLog('error', 'è«‹å¡«å¯«å®Œæ•´çš„æ’¤éŠ·è³‡è¨Š');
        return;
      }

      // ç¢ºèªæ’¤éŠ·
      const confirmed = confirm(
        `ç¢ºå®šè¦æ’¤éŠ·ä»¥ä¸‹èªè­‰å—ï¼Ÿ\n\n` +
        `Commitment: ${commitment.substring(0, 16)}...\n` +
        `åŸå› : ${reason}\n\n` +
        `æ­¤æ“ä½œä¸å¯é€†ï¼`
      );
      
      if (!confirmed) return;

      try {
        const response = await fetch(`${API_BASE}/revoke`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ commitment, reason })
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
          addLog('revoked', `âœ… èªè­‰æ’¤éŠ·æˆåŠŸ: ${commitment.substring(0, 16)}... (${reason})`);
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('commitment').value = '';
          document.getElementById('reason').value = '';
          
          // é‡æ–°è¼‰å…¥çµ±è¨ˆ
          setTimeout(loadStats, 1000);
        } else {
          throw new Error(result.error || 'æ’¤éŠ·å¤±æ•—');
        }
      } catch (error) {
        console.error('æ’¤éŠ·éŒ¯èª¤:', error);
        addLog('error', 'æ’¤éŠ·å¤±æ•—: ' + error.message);
      }
    }

    /**
     * æ·»åŠ æ—¥èªŒæ¢ç›®
     */
    function addLog(type, message) {
      const timestamp = new Date().toLocaleString('zh-TW');
      const logEntry = {
        type: type,
        message: message,
        timestamp: timestamp
      };
      
      operationLog.unshift(logEntry);
      
      // åªä¿ç•™æœ€è¿‘50æ¢è¨˜éŒ„
      if (operationLog.length > 50) {
        operationLog = operationLog.slice(0, 50);
      }
      
      updateLogDisplay();
    }

    /**
     * æ›´æ–°æ—¥èªŒé¡¯ç¤º
     */
    function updateLogDisplay() {
      const container = document.getElementById('logContainer');
      
      if (operationLog.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6c757d;">æš«ç„¡æ“ä½œè¨˜éŒ„</div>';
        return;
      }
      
      const logHTML = operationLog.map(log => `
        <div class="log-entry ${log.type}">
          <div>${log.message}</div>
          <div class="log-timestamp">${log.timestamp}</div>
        </div>
      `).join('');
      
      container.innerHTML = logHTML;
    }

    /**
     * è¼‰å…¥æª¢èˆ‰äººè¨˜éŒ„
     */
    async function loadReporterRecords() {
      try {
        const response = await fetch('http://localhost:3000/admin/reporter-records');
        const result = await response.json();
        
        if (response.ok && result.success) {
          displayReporterRecords(result.records);
          addLog('success', `è¼‰å…¥äº† ${result.total} ç­†æª¢èˆ‰äººè¨˜éŒ„`);
        } else {
          throw new Error(result.error || 'è¼‰å…¥æª¢èˆ‰äººè¨˜éŒ„å¤±æ•—');
        }
      } catch (error) {
        console.error('è¼‰å…¥æª¢èˆ‰äººè¨˜éŒ„éŒ¯èª¤:', error);
        addLog('error', 'è¼‰å…¥æª¢èˆ‰äººè¨˜éŒ„å¤±æ•—: ' + error.message);
      }
    }

    /**
     * æœå°‹ç‰¹å®šæª¢èˆ‰äºº
     */
    async function searchReporter() {
      const commitment = document.getElementById('searchCommitment').value.trim();
      
      if (!commitment) {
        addLog('error', 'è«‹è¼¸å…¥ commitment');
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3000/admin/reporter/${commitment}`);
        const result = await response.json();
        
        if (response.ok && result.success) {
          displayReporterRecords(result.records, result.commitment);
          addLog('success', `æ‰¾åˆ°æª¢èˆ‰äºº ${commitment.substring(0, 16)}... çš„ ${result.total} ç­†è¨˜éŒ„`);
        } else {
          throw new Error(result.error || 'æœå°‹å¤±æ•—');
        }
      } catch (error) {
        console.error('æœå°‹æª¢èˆ‰äººéŒ¯èª¤:', error);
        addLog('error', 'æœå°‹å¤±æ•—: ' + error.message);
      }
    }

    /**
     * é¡¯ç¤ºæª¢èˆ‰äººè¨˜éŒ„
     */
    function displayReporterRecords(records, searchCommitment = null) {
      const container = document.getElementById('reporterRecords');
      
      if (!records || records.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #6c757d;">
            ${searchCommitment ? 'æœªæ‰¾åˆ°è©²æª¢èˆ‰äººçš„è¨˜éŒ„' : 'æš«ç„¡æª¢èˆ‰äººè¨˜éŒ„'}
          </div>
        `;
        return;
      }
      
      const title = searchCommitment 
        ? `æª¢èˆ‰äºº ${searchCommitment.substring(0, 16)}... çš„è¨˜éŒ„ (${records.length} ç­†)`
        : `æ‰€æœ‰æª¢èˆ‰äººè¨˜éŒ„ (${records.length} ç­†)`;
      
      const recordsHTML = records.map(record => {
        const date = new Date(record.createdAt).toLocaleString('zh-TW');
        const tags = record.tags && record.tags.length > 0 
          ? record.tags.join(', ') 
          : 'ç„¡æ¨™ç±¤';
        
        return `
          <div class="log-entry" style="border-left-color: #007bff;">
            <div><strong>ğŸ“ CID:</strong> ${record.cid}</div>
            <div><strong>ğŸ†” åŒ¿åèº«åˆ†:</strong> <code>${record.reporterCommitment.substring(0, 16)}...</code></div>
            <div><strong>ğŸ¯ æª¢èˆ‰è­˜åˆ¥ç¢¼:</strong> <code>${record.nullifierHash ? record.nullifierHash.substring(0, 16) + '...' : 'ç„¡'}</code></div>
            <div><strong>ğŸ” ZKP ç‹€æ…‹:</strong> ${record.zkpVerified ? 'âœ… å·²é©—è­‰' : 'âŒ æœªé©—è­‰'}</div>
            <div><strong>ğŸ·ï¸ æ¨™ç±¤:</strong> ${tags}</div>
            <div><strong>ğŸ“„ å…§å®¹é è¦½:</strong> ${record.contentPreview}</div>
            <div class="log-timestamp">${date}</div>
            <div style="margin-top: 10px;">
              <button class="btn-danger" onclick="revokeReporter('${record.reporterCommitment}')" style="font-size: 0.8rem; padding: 6px 12px;">
                ğŸš« æ’¤éŠ·æ­¤æª¢èˆ‰äºº
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = `
        <div style="margin-bottom: 15px; font-weight: bold; color: #333;">
          ${title}
        </div>
        ${recordsHTML}
      `;
    }

    /**
     * æ’¤éŠ·æª¢èˆ‰äºº
     */
    async function revokeReporter(commitment) {
      const reason = prompt(`ç¢ºå®šè¦æ’¤éŠ·æª¢èˆ‰äººçš„èªè­‰å—ï¼Ÿ\n\nCommitment: ${commitment.substring(0, 16)}...\n\nè«‹è¼¸å…¥æ’¤éŠ·åŸå› :`);
      
      if (!reason) return;
      
      try {
        const response = await fetch(`${API_BASE}/revoke`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ commitment, reason })
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
          addLog('revoked', `âœ… æª¢èˆ‰äººèªè­‰æ’¤éŠ·æˆåŠŸ: ${commitment.substring(0, 16)}... (${reason})`);
          
          // é‡æ–°è¼‰å…¥çµ±è¨ˆå’Œè¨˜éŒ„
          setTimeout(() => {
            loadStats();
            loadReporterRecords();
          }, 1000);
        } else {
          throw new Error(result.error || 'æ’¤éŠ·å¤±æ•—');
        }
      } catch (error) {
        console.error('æ’¤éŠ·æª¢èˆ‰äººéŒ¯èª¤:', error);
        addLog('error', 'æ’¤éŠ·å¤±æ•—: ' + error.message);
      }
    }

    /**
     * åŒ¯å‡ºè¨˜éŒ„
     */
    async function exportRecords() {
      try {
        const response = await fetch('http://localhost:3000/admin/reporter-records');
        const result = await response.json();
        
        if (response.ok && result.success) {
          const csvContent = generateCSV(result.records);
          downloadCSV(csvContent, `reporter-records-${new Date().toISOString().split('T')[0]}.csv`);
          addLog('success', `åŒ¯å‡ºäº† ${result.total} ç­†è¨˜éŒ„`);
        } else {
          throw new Error(result.error || 'åŒ¯å‡ºå¤±æ•—');
        }
      } catch (error) {
        console.error('åŒ¯å‡ºéŒ¯èª¤:', error);
        addLog('error', 'åŒ¯å‡ºå¤±æ•—: ' + error.message);
      }
    }

    /**
     * ç”Ÿæˆ CSV
     */
    function generateCSV(records) {
      const headers = ['CID', 'åŒ¿åèº«åˆ†', 'æª¢èˆ‰è­˜åˆ¥ç¢¼', 'ZKPé©—è­‰', 'æ¨™ç±¤', 'å…§å®¹é è¦½', 'æ™‚é–“'];
      const rows = records.map(record => [
        record.cid,
        record.reporterCommitment,
        record.nullifierHash || '',
        record.zkpVerified ? 'æ˜¯' : 'å¦',
        record.tags ? record.tags.join(';') : '',
        record.contentPreview.replace(/"/g, '""'),
        record.createdAt
      ]);
      
      const csvContent = [headers, ...rows]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');
      
      return csvContent;
    }

    /**
     * ä¸‹è¼‰ CSV
     */
    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // åˆå§‹åŒ–æ—¥èªŒé¡¯ç¤º
    updateLogDisplay();
  </script>
</body>
</html>
