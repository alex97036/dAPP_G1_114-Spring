<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è©é¨™æª¢èˆ‰å¹³å° Demo - æ”¹é€²ç‰ˆ</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px; 
      max-width: 800px; 
      margin: auto; 
      background-color: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1, h2 { color: #333; margin-bottom: 20px; }
    h1 { border-bottom: 3px solid #007bff; padding-bottom: 10px; }
    
    .info-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    
    button {
      font-size: 1rem;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    #connectBtn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      font-weight: bold;
    }
    
    #connectBtn:hover { transform: translateY(-2px); }
    
    #disconnectBtn {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      font-weight: bold;
      margin-left: 15px;
    }
    
    #disconnectBtn:hover { 
      transform: translateY(-2px);
      background: linear-gradient(135deg, #c82333, #bd2130);
    }
    
    #reportForm, #history { 
      margin-top: 30px; 
      display: none; 
    }
    
    textarea { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 15px;
      resize: vertical;
    }
    
    textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    #submitBtn {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      font-weight: bold;
    }
    
    #submitBtn:hover:not(:disabled) { transform: translateY(-2px); }
    #submitBtn:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none;
    }
    
    .report-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      flex: 1;
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #d63384;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .reports-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
    }
    
    .report-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    
    .report-item:hover {
      background: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .report-time {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .report-index {
      background: #007bff;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .report-details {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      font-size: 0.9rem;
    }
    
    .detail-label {
      font-weight: bold;
      color: #495057;
    }
    
    .detail-value {
      color: #6c757d;
      word-break: break-all;
    }
    
    .cid-value {
      font-family: 'Courier New', monospace;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .loading { 
      opacity: 0.6; 
      pointer-events: none; 
    }
    
    .error { 
      color: #dc3545; 
      background: #f8d7da;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    
    .success { 
      color: #155724; 
      background: #d4edda;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      display: block;
    }
    
    .refresh-btn {
      background: #6c757d;
      color: white;
      padding: 8px 16px;
      font-size: 0.9rem;
      margin-left: 15px;
    }
    
    .refresh-btn:hover {
      background: #5a6268;
    }
    
    /* æ¨™ç±¤ç›¸é—œæ¨£å¼ */
    .tags-section {
      margin-bottom: 20px;
    }
    
    .tags-label {
      font-weight: bold;
      color: #495057;
      margin-bottom: 10px;
      display: block;
    }
    
    .tag-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .tag-btn {
      padding: 6px 12px;
      border: 2px solid #007bff;
      background: white;
      color: #007bff;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }
    
    .tag-btn:hover {
      background: #e7f3ff;
      transform: translateY(-1px);
    }
    
    .tag-btn.selected {
      background: #007bff;
      color: white;
    }
    
    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      min-height: 24px;
    }
    
    .selected-tag {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .tag-filter {
      margin-bottom: 15px;
    }
    
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .filter-btn {
      padding: 4px 10px;
      border: 1px solid #6c757d;
      background: white;
      color: #6c757d;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .filter-btn:hover {
      background: #f8f9fa;
    }
    
    .filter-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ›¡ï¸ è©é¨™æª¢èˆ‰å¹³å° Demo</h1>
    <div class="info-box">
      ğŸ“ <strong>Demo èªªæ˜</strong>: æ­¤ç‰ˆæœ¬ä½¿ç”¨æ¨¡æ“¬ IPFS CIDï¼Œæª¢èˆ‰å…§å®¹é€é SHA256 é›œæ¹Šç”Ÿæˆå”¯ä¸€è­˜åˆ¥ç¢¼ï¼Œä¸¦å­˜å„²åœ¨å€å¡Šéˆä¸Šã€‚æ‰€æœ‰æª¢èˆ‰è¨˜éŒ„å°‡æ°¸ä¹…ä¿å­˜ä¸”å…¬é–‹é€æ˜ã€‚
    </div>

    <!-- é€£æ¥éŒ¢åŒ…æŒ‰éˆ• -->
    <div id="walletControls">
      <button id="connectBtn">ğŸ” é–‹å§‹ ZKP èªè­‰</button>
      <button id="disconnectBtn" style="display: none;">ğŸ”Œ æ–·é–‹éŒ¢åŒ…é€£æ¥</button>
      <button id="settingsBtn" style="margin-left: 10px;">âš™ï¸ è¨­ç½®</button>
    </div>

    <!-- è¨­ç½®é¢æ¿ -->
    <div id="settingsPanel" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
      <h3>âš™ï¸ åˆç´„è¨­ç½®</h3>
      <div style="margin-bottom: 10px;">
        <label for="contractAddressInput" style="display: block; margin-bottom: 5px;">æ™ºèƒ½åˆç´„åœ°å€:</label>
        <input type="text" id="contractAddressInput" placeholder="0x..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
      </div>
      <button id="updateContractBtn" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">ğŸ“ æ›´æ–°åˆç´„åœ°å€</button>
      <button id="cancelSettingsBtn" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">âŒ å–æ¶ˆ</button>
    </div>

    <!-- æª¢èˆ‰è¡¨å–® -->
    <form id="reportForm">
      <h2>ğŸ“ æäº¤æª¢èˆ‰</h2>
      
      <!-- æ¨™ç±¤é¸æ“‡å€åŸŸ -->
      <div class="tags-section">
        <label class="tags-label">ğŸ“‹ é¸æ“‡è©é¨™é¡å‹æ¨™ç±¤ (å¯å¤šé¸):</label>
        <div class="tag-buttons">
          <button type="button" class="tag-btn" data-tag="ç¶²è·¯è©é¨™">ğŸŒ ç¶²è·¯è©é¨™</button>
          <button type="button" class="tag-btn" data-tag="æŠ•è³‡è©é¨™">ğŸ’° æŠ•è³‡è©é¨™</button>
          <button type="button" class="tag-btn" data-tag="åŠ å¯†è²¨å¹£">â‚¿ åŠ å¯†è²¨å¹£</button>
          <button type="button" class="tag-btn" data-tag="é›»è©±è©é¨™">ğŸ“ é›»è©±è©é¨™</button>
          <button type="button" class="tag-btn" data-tag="ç°¡è¨Šè©é¨™">ğŸ“± ç°¡è¨Šè©é¨™</button>
          <button type="button" class="tag-btn" data-tag="é‡£é­šç¶²ç«™">ğŸ£ é‡£é­šç¶²ç«™</button>
          <button type="button" class="tag-btn" data-tag="å‡å†’èº«ä»½">ğŸ‘¤ å‡å†’èº«ä»½</button>
          <button type="button" class="tag-btn" data-tag="è³¼ç‰©è©é¨™">ğŸ›’ è³¼ç‰©è©é¨™</button>
          <button type="button" class="tag-btn" data-tag="æ„›æƒ…è©é¨™">ğŸ’• æ„›æƒ…è©é¨™</button>
          <button type="button" class="tag-btn" data-tag="æ±‚è·è©é¨™">ğŸ’¼ æ±‚è·è©é¨™</button>
          <button type="button" class="tag-btn" data-tag="å…¶ä»–">â“ å…¶ä»–</button>
        </div>
        <div>
          <strong>å·²é¸æ“‡æ¨™ç±¤ï¼š</strong>
          <div class="selected-tags" id="selectedTags">
            <span style="color: #6c757d; font-style: italic;">è«‹é¸æ“‡è©é¨™é¡å‹æ¨™ç±¤</span>
          </div>
        </div>
      </div>
      
      <textarea id="content" rows="4" placeholder="è«‹è©³ç´°æè¿°è©é¨™æƒ…æ³ï¼ŒåŒ…æ‹¬ï¼š
â€¢ è©é¨™æ‰‹æ³•
â€¢ æ¶‰åŠé‡‘é¡
â€¢ è©é¨™æ–¹è¯çµ¡æ–¹å¼
â€¢ å…¶ä»–ç›¸é—œè­‰æ“š..."></textarea>
      <button type="submit" id="submitBtn">ğŸš€ é€å‡ºæª¢èˆ‰</button>
    </form>

    <!-- æª¢èˆ‰æ­·å² -->
    <div id="history">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <h2>ğŸ“‹ æª¢èˆ‰è¨˜éŒ„</h2>
        <button id="refreshBtn" class="refresh-btn">ğŸ”„ é‡æ–°è¼‰å…¥</button>
      </div>
      
      <!-- æ¨™ç±¤ç¯©é¸å™¨ -->
      <div class="tag-filter">
        <strong>ğŸ“Œ ä¾æ¨™ç±¤ç¯©é¸æª¢èˆ‰è¨˜éŒ„ï¼š</strong>
        <div class="filter-buttons" id="filterButtons">
          <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
        </div>
      </div>
      
      <div class="report-stats">
        <div class="stat-card">
          <div class="stat-number" id="totalReports">0</div>
          <div class="stat-label">ç¸½æª¢èˆ‰æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="todayReports">0</div>
          <div class="stat-label">ä»Šæ—¥æª¢èˆ‰</div>
        </div>
      </div>
      
      <div class="reports-container" id="reportsContainer">
        <div class="empty-state">
          <div>ğŸ“Š</div>
          <div>è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ethers.js UMD bundle -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- ZKP èªè­‰æ¨¡çµ„ -->
  <script src="zkp-auth.js"></script>
  <script src="zkp-auth-ui.js"></script>
  
  <!-- æ™ºèƒ½åˆç´„ ABI -->
  <script src="contract-abi.js"></script>
  
  <script>
    let selectedTags = [];
    let currentFilter = 'all';
    
    // æ¨™ç±¤é¸æ“‡åŠŸèƒ½
    function initializeTagSelection() {
      console.log('åˆå§‹åŒ–æ¨™ç±¤é¸æ“‡åŠŸèƒ½...');
      const tagButtons = document.querySelectorAll('.tag-btn');
      const selectedTagsEl = document.getElementById('selectedTags');
      
      tagButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tag = button.dataset.tag;
          console.log('é»æ“Šæ¨™ç±¤:', tag);
          
          if (button.classList.contains('selected')) {
            // å–æ¶ˆé¸æ“‡
            button.classList.remove('selected');
            selectedTags = selectedTags.filter(t => t !== tag);
          } else {
            // é¸æ“‡æ¨™ç±¤
            button.classList.add('selected');
            selectedTags.push(tag);
          }
          
          updateSelectedTagsDisplay();
        });
      });
    }

    // æ›´æ–°å·²é¸æ“‡æ¨™ç±¤çš„é¡¯ç¤º
    function updateSelectedTagsDisplay() {
      const selectedTagsEl = document.getElementById('selectedTags');
      if (selectedTags.length === 0) {
        selectedTagsEl.innerHTML = '<span style="color: #6c757d; font-style: italic;">è«‹é¸æ“‡è©é¨™é¡å‹æ¨™ç±¤</span>';
      } else {
        selectedTagsEl.innerHTML = selectedTags.map(tag => 
          `<span class="selected-tag">${tag}</span>`
        ).join('');
      }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æ¨™ç±¤é¸æ“‡åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ–æ¨™ç±¤åŠŸèƒ½');
      initializeTagSelection();
    });

  (async()=>{
    if (typeof ethers === 'undefined') {
      return alert('è«‹å…ˆç¢ºèªå·²è¼‰å…¥ ethers.js');
    }

    // åˆç´„åœ°å€ (å¯åœ¨é é¢è¨­ç½®ä¸­ä¿®æ”¹ï¼Œé è¨­ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ä¸­çš„åœ°å€)
    let contractAddress = DEFAULT_CONTRACT_ADDRESS;
    
    // ä½¿ç”¨å¤–éƒ¨ ABI æª”æ¡ˆä¸­çš„å®šç¾©
    const contractABI = CONTRACT_ABI;

    let contract;
    let currentReports = [];
    let currentAccount = null;
    let provider = null;
    
    // DOM å…ƒç´ 
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const contractAddressInput = document.getElementById('contractAddressInput');
    const updateContractBtn = document.getElementById('updateContractBtn');
    const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
    const reportForm = document.getElementById('reportForm');
    const historyDiv = document.getElementById('history');
    const reportsContainer = document.getElementById('reportsContainer');
    const textarea = document.getElementById('content');
    const submitBtn = document.getElementById('submitBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const totalReportsEl = document.getElementById('totalReports');
    const todayReportsEl = document.getElementById('todayReports');
    const selectedTagsEl = document.getElementById('selectedTags');
    const filterButtonsEl = document.getElementById('filterButtons');

    // åˆå§‹åŒ–åˆç´„åœ°å€è¼¸å…¥æ¡†
    contractAddressInput.value = contractAddress;
    
    // è¨­ç½®é¢æ¿ç›¸é—œåŠŸèƒ½
    settingsBtn.addEventListener('click', () => {
      settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
      contractAddressInput.value = contractAddress; // é¡¯ç¤ºç•¶å‰åœ°å€
    });
    
    cancelSettingsBtn.addEventListener('click', () => {
      settingsPanel.style.display = 'none';
      contractAddressInput.value = contractAddress; // é‡ç½®ç‚ºç•¶å‰åœ°å€
    });
    
    updateContractBtn.addEventListener('click', () => {
      const newAddress = contractAddressInput.value.trim();
      if (!newAddress) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åˆç´„åœ°å€');
        return;
      }
      if (!ethers.utils.isAddress(newAddress)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€æ ¼å¼');
        return;
      }
      
      contractAddress = newAddress;
      alert(`åˆç´„åœ°å€å·²æ›´æ–°ç‚º: ${newAddress}`);
      settingsPanel.style.display = 'none';
      
      // å¦‚æœå·²é€£æ¥éŒ¢åŒ…ï¼Œé‡æ–°åˆå§‹åŒ–åˆç´„
      if (currentAccount && window.ethereum) {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
      }
    });

    // ZKP èªè­‰ + é€£æ¥ MetaMaskï¼ˆä¿®æ”¹åŸæœ¬çš„é€£æ¥é‚è¼¯ï¼‰
    connectBtn.addEventListener('click', async() => {
      try {
        // 1. å…ˆæª¢æŸ¥æ˜¯å¦å·²å®Œæˆ ZKP èªè­‰
        if (!window.zkpAuth || !window.zkpAuth.isAuthenticated) {
          // é¡¯ç¤º ZKP èªè­‰æ¨¡æ…‹æ¡†
          window.zkpAuthUI.showAuthModal();
          return;
        }

        // 2. ZKP èªè­‰å®Œæˆå¾Œï¼ŒåŸ·è¡ŒåŸæœ¬çš„ MetaMask é€£æ¥é‚è¼¯
        await window.connectMetaMask();
        
      } catch(e) {
        console.error('èªè­‰æˆ–é€£æ¥éŒ¯èª¤:', e);
        showError('èªè­‰æˆ–é€£æ¥éŒ¯èª¤: ' + e.message);
      }
    });

    // åŸæœ¬çš„ MetaMask é€£æ¥é‚è¼¯ï¼ˆæ‹†åˆ†å‡ºä¾†ä¸¦è¨­ç‚ºå…¨åŸŸå‡½æ•¸ï¼‰
    window.connectMetaMask = async function() {
      if (!window.ethereum) throw new Error('è«‹å…ˆå®‰è£ MetaMask');
      
      provider = new ethers.providers.Web3Provider(window.ethereum);
      
      // è«‹æ±‚å¸³è™Ÿæ¬Šé™
      const accounts = await provider.send('eth_requestAccounts', []);
      currentAccount = accounts[0];
      console.log('é€£æ¥çš„å¸³è™Ÿ:', currentAccount);
      
      const signer = provider.getSigner();
      contract = new ethers.Contract(contractAddress, contractABI, signer);

      // æª¢æŸ¥ç¶²è·¯
      const network = await provider.getNetwork();
      if (network.chainId !== 11155111) {
        alert('è«‹åˆ‡æ›åˆ° Sepolia æ¸¬è©¦ç¶²è·¯');
        return;
      }

      // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
      if (window.ethereum) {
        window.ethereum.removeAllListeners('accountsChanged');
        window.ethereum.removeAllListeners('chainChanged');
      }

      // ç›£è½å¸³è™Ÿè®Šæ›´
      window.ethereum.on('accountsChanged', handleAccountsChanged);
      window.ethereum.on('chainChanged', handleChainChanged);

      // æ›´æ–° UI é¡¯ç¤ºç•¶å‰å¸³è™Ÿ
      updateAccountDisplay();

      // é¡¯ç¤ºä»‹é¢
      connectBtn.style.display = 'none';
      disconnectBtn.style.display = 'inline-block';
      reportForm.style.display = 'block';
      historyDiv.style.display = 'block';

      // è¼‰å…¥æ­·å²è¨˜éŒ„
      await loadHistory();
      subscribeEvents();
    }

    // æ–·é–‹éŒ¢åŒ…é€£æ¥ï¼ˆåŒæ™‚æ¸…é™¤ ZKP èªè­‰ï¼‰
    disconnectBtn.addEventListener('click', async() => {
      try {
        // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        const confirmed = confirm('ç¢ºå®šè¦æ–·é–‹éŒ¢åŒ…é€£æ¥å—ï¼Ÿ\n\næ–·é–‹é€£æ¥å¾Œå°‡æ¸…é™¤ ZKP èªè­‰ï¼Œéœ€è¦é‡æ–°é€²è¡Œèº«åˆ†é©—è­‰ã€‚');
        if (!confirmed) return;

        console.log('ç”¨æˆ¶ä¸»å‹•æ–·é–‹éŒ¢åŒ…é€£æ¥');
        
        // æ¸…ç† ZKP èªè­‰ç‹€æ…‹
        if (window.zkpAuth) {
          window.zkpAuth.logout();
          console.log('âœ… ZKP èªè­‰å·²æ¸…é™¤');
        }
        
        // æ¸…ç†éŒ¢åŒ…ç‹€æ…‹
        currentAccount = null;
        provider = null;
        contract = null;
        currentReports = [];
        
        // ç§»é™¤äº‹ä»¶ç›£è½å™¨
        if (window.ethereum) {
          window.ethereum.removeAllListeners('accountsChanged');
          window.ethereum.removeAllListeners('chainChanged');
        }
        
        // ç§»é™¤å¸³è™Ÿä¿¡æ¯é¡¯ç¤º
        const accountInfo = document.getElementById('accountInfo');
        if (accountInfo) accountInfo.remove();
        
        // é‡ç½® UI
        connectBtn.textContent = 'ğŸ” é–‹å§‹ ZKP èªè­‰';
        connectBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'none';
        reportForm.style.display = 'none';
        historyDiv.style.display = 'none';
        
        // æ¸…ç©ºè¡¨å–®
        textarea.value = '';
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ é€å‡ºæª¢èˆ‰';
        
        // é¡¯ç¤ºæ–·é–‹æˆåŠŸè¨Šæ¯
        const successMsg = document.createElement('div');
        successMsg.className = 'success';
        successMsg.innerHTML = 'âœ… éŒ¢åŒ…é€£æ¥å·²æˆåŠŸæ–·é–‹ï¼Œæ„Ÿè¬æ‚¨çš„ä½¿ç”¨ï¼';
        connectBtn.parentNode.appendChild(successMsg);
        
        setTimeout(() => {
          if (successMsg.parentNode) {
            successMsg.remove();
          }
        }, 3000);
        
      } catch (error) {
        console.error('æ–·é–‹é€£æ¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('æ–·é–‹é€£æ¥æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      }
    });

    // è™•ç†å¸³è™Ÿè®Šæ›´
    async function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        // ç”¨æˆ¶åœ¨ MetaMask ä¸­æ–·é–‹é€£æ¥
        console.log('ç”¨æˆ¶åœ¨ MetaMask ä¸­æ–·é–‹é€£æ¥');
        location.reload();
      } else {
        // ç”¨æˆ¶åˆ‡æ›å¸³è™Ÿ
        const newAccount = accounts[0];
        if (newAccount !== currentAccount) {
          console.log('å¸³è™Ÿå·²è®Šæ›´:', { èˆŠå¸³è™Ÿ: currentAccount, æ–°å¸³è™Ÿ: newAccount });
          currentAccount = newAccount;
          
          // é‡æ–°åˆå§‹åŒ–åˆç´„
          const signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          
          // æ›´æ–° UI
          updateAccountDisplay();
          
          // é‡æ–°è¼‰å…¥æ•¸æ“š
          await loadHistory();
        }
      }
    }

    // è™•ç†ç¶²è·¯è®Šæ›´
    function handleChainChanged(chainId) {
      console.log('ç¶²è·¯å·²è®Šæ›´:', chainId);
      location.reload();
    }

    // æ›´æ–°å¸³è™Ÿé¡¯ç¤º
    function updateAccountDisplay() {
      if (currentAccount) {
        const shortAccount = `${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}`;
        const accountInfo = document.createElement('div');
        accountInfo.id = 'accountInfo';
        accountInfo.style.cssText = `
          background: #e3f2fd;
          padding: 10px;
          border-radius: 6px;
          margin-bottom: 20px;
          font-size: 0.9rem;
          color: #1565c0;
        `;
        accountInfo.innerHTML = `ğŸ‘¤ ç•¶å‰å¸³è™Ÿ: <strong>${shortAccount}</strong> (${currentAccount})`;
        
        // ç§»é™¤èˆŠçš„å¸³è™Ÿä¿¡æ¯
        const oldAccountInfo = document.getElementById('accountInfo');
        if (oldAccountInfo) oldAccountInfo.remove();
        
        // æ·»åŠ åˆ°æª¢èˆ‰è¡¨å–®å‰é¢
        reportForm.insertBefore(accountInfo, reportForm.firstChild);
      }
    }

    // è¼‰å…¥æª¢èˆ‰æ­·å²
    async function loadHistory() {
      try {
        showLoadingState();
        
        // å˜—è©¦å¾å¾Œç«¯ API ç²å–
        const response = await fetch('http://localhost:3000/reports');
        const data = await response.json();
        
        if (data.success && Array.isArray(data.reports)) {
          currentReports = data.reports.sort((a, b) => b.timestamp - a.timestamp);
          console.log(`âœ… å¾å¾Œç«¯è¼‰å…¥ ${currentReports.length} ç­†æª¢èˆ‰è¨˜éŒ„`);
        } else {
          throw new Error('å¾Œç«¯ API å›æ‡‰æ ¼å¼éŒ¯èª¤');
        }
        
      } catch (apiError) {
        console.warn('å¾Œç«¯ API å¤±æ•—ï¼Œå˜—è©¦å¾å€å¡Šéˆè¼‰å…¥:', apiError);
        
        try {
          // å¾æ™ºèƒ½åˆç´„ç›´æ¥è®€å–
          const count = await contract.getReportCount();
          const reports = [];
          
          for (let i = 0; i < count.toNumber(); i++) {
            const [reporter, cid, timestamp] = await contract.getReport(i);
            reports.push({
              reporter,
              cid,
              timestamp: timestamp.toNumber()
            });
          }
          
          currentReports = reports.sort((a, b) => b.timestamp - a.timestamp);
          console.log(`âœ… å¾å€å¡Šéˆè¼‰å…¥ ${currentReports.length} ç­†æª¢èˆ‰è¨˜éŒ„`);
          
        } catch (contractError) {
          console.error('å¾åˆç´„è¼‰å…¥å¤±æ•—:', contractError);
          showError('è¼‰å…¥æª¢èˆ‰è¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
          return;
        }
      }
      
      updateReportsDisplay();
      updateStats();
      updateFilterButtons();
    }

    // æ›´æ–°æª¢èˆ‰è¨˜éŒ„é¡¯ç¤º
    function updateReportsDisplay() {
      const reportsToDisplay = filterReports();
      
      if (reportsToDisplay.length === 0) {
        reportsContainer.innerHTML = `
          <div class="empty-state">
            <div>ğŸ“</div>
            <div>å°šç„¡æª¢èˆ‰è¨˜éŒ„</div>
            <div style="font-size: 0.9rem; color: #adb5bd; margin-top: 10px;">
              æˆç‚ºç¬¬ä¸€å€‹æäº¤æª¢èˆ‰çš„äººï¼
            </div>
          </div>
        `;
        return;
      }

      const reportsHtml = reportsToDisplay.map((report, index) => {
        const date = new Date(report.timestamp * 1000);
        const shortReporter = `${report.reporter.substring(0, 6)}...${report.reporter.substring(38)}`;
        const shortCid = `${report.cid.substring(0, 12)}...${report.cid.substring(report.cid.length - 8)}`;
        
        // è™•ç†æª¢èˆ‰å…§å®¹é¡¯ç¤º
        const contentPreview = report.content 
          ? (report.content.length > 100 
              ? report.content.substring(0, 100) + '...' 
              : report.content)
          : 'å…§å®¹ä¸å¯ç”¨';
        
        const contentStatus = report.hasContent ? 'âœ… å…§å®¹å¯ç”¨' : 'âš ï¸ å…§å®¹ä¸å¯ç”¨';
        
        // è™•ç†æ¨™ç±¤é¡¯ç¤º
        const tagsHtml = report.tags && report.tags.length > 0 
          ? report.tags.map(tag => `<span class="selected-tag">${tag}</span>`).join('')
          : '<span style="color: #6c757d; font-style: italic;">ç„¡æ¨™ç±¤</span>';
        
        // è™•ç† ZKP åŒ¿åæª¢èˆ‰äººè³‡è¨Šé¡¯ç¤º
        const zkpInfo = report.reporterCommitment 
          ? `
            <div class="detail-label">ğŸ” ZKP èªè­‰ç‹€æ…‹:</div>
            <div class="detail-value">
              <span style="color: #28a745; font-weight: bold;">âœ… å·²é€šé ZKP é©—è­‰</span>
            </div>
            <div class="detail-label">ğŸ†” åŒ¿åèº«åˆ†:</div>
            <div class="detail-value">
              <code style="font-size: 0.8rem; background: #e9ecef; padding: 2px 6px; border-radius: 3px;">
                ${report.reporterCommitment.substring(0, 16)}...
              </code>
            </div>
            <div class="detail-label">ğŸ¯ æª¢èˆ‰è­˜åˆ¥ç¢¼:</div>
            <div class="detail-value">
              <code style="font-size: 0.8rem; background: #e9ecef; padding: 2px 6px; border-radius: 3px;">
                ${report.nullifierHash ? report.nullifierHash.substring(0, 16) + '...' : 'ç„¡'}
              </code>
            </div>
          `
          : `
            <div class="detail-label">ğŸ” ZKP èªè­‰ç‹€æ…‹:</div>
            <div class="detail-value">
              <span style="color: #6c757d;">âšª èˆŠè¨˜éŒ„ï¼ˆæœªä½¿ç”¨ ZKPï¼‰</span>
            </div>
          `;
        
        return `
          <div class="report-item">
            <div class="report-header">
              <div class="report-time">${date.toLocaleString('zh-TW')}</div>
              <div class="report-index">#${currentReports.length - index}</div>
            </div>
            <div class="report-details">
              <div class="detail-label">æª¢èˆ‰äºº:</div>
              <div class="detail-value">${shortReporter}</div>
              ${zkpInfo}
              <div class="detail-label">è©é¨™é¡å‹æ¨™ç±¤:</div>
              <div class="detail-value">${tagsHtml}</div>
              <div class="detail-label">æª¢èˆ‰å…§å®¹:</div>
              <div class="detail-value" style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">
                "${contentPreview}"
              </div>
              <div class="detail-label">å…§å®¹ ID:</div>
              <div class="detail-value">
                <span class="cid-value">${shortCid}</span>
              </div>
              <div class="detail-label">ç‹€æ…‹:</div>
              <div class="detail-value">${contentStatus}</div>
              <div class="detail-label">å®Œæ•´åœ°å€:</div>
              <div class="detail-value" style="font-size: 0.8rem;">${report.reporter}</div>
              <div class="detail-label">å®Œæ•´ CID:</div>
              <div class="detail-value" style="font-size: 0.8rem;">${report.cid}</div>
            </div>
          </div>
        `;
      }).join('');

      reportsContainer.innerHTML = reportsHtml;
    }

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    function updateStats() {
      totalReportsEl.textContent = currentReports.length;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayTimestamp = today.getTime() / 1000;
      
      const todayCount = currentReports.filter(report => 
        report.timestamp >= todayTimestamp
      ).length;
      
      todayReportsEl.textContent = todayCount;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    function showLoadingState() {
      reportsContainer.innerHTML = `
        <div class="empty-state">
          <div>â³</div>
          <div>è¼‰å…¥æª¢èˆ‰è¨˜éŒ„ä¸­...</div>
        </div>
      `;
    }

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message) {
      reportsContainer.innerHTML = `
        <div class="error">
          âŒ ${message}
        </div>
      `;
    }

    // è¨‚é–±æ–°äº‹ä»¶
    function subscribeEvents() {
      contract.on('ReportSubmitted', (reporter, cid, timestamp) => {
        console.log('æ”¶åˆ°æ–°æª¢èˆ‰äº‹ä»¶:', { reporter, cid, timestamp: timestamp.toNumber() });
        
        // æ·»åŠ åˆ°ç•¶å‰è¨˜éŒ„
        currentReports.unshift({
          reporter,
          cid,
          timestamp: timestamp.toNumber()
        });
           updateReportsDisplay();
      updateStats();
      updateFilterButtons();
    });
    }

    // é‡æ–°è¼‰å…¥æŒ‰éˆ•
    refreshBtn.addEventListener('click', loadHistory);

    // æäº¤æª¢èˆ‰ï¼ˆåŠ å…¥ ZKP Proof é©—è­‰ï¼‰
    reportForm.addEventListener('submit', async(e) => {
      e.preventDefault();
      const content = textarea.value.trim();
      if (!content) {
        alert('è«‹è¼¸å…¥æª¢èˆ‰å…§å®¹');
        return;
      }
      
      if (selectedTags.length === 0) {
        const confirmed = confirm('æ‚¨å°šæœªé¸æ“‡ä»»ä½•è©é¨™é¡å‹æ¨™ç±¤ï¼Œç¢ºå®šè¦ç¹¼çºŒæäº¤å—ï¼Ÿ');
        if (!confirmed) return;
      }
      
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ ç”Ÿæˆ ZK Proof...';
        
        // 1. æª¢æŸ¥ ZKP èªè­‰ç‹€æ…‹
        if (!window.zkpAuth || !window.zkpAuth.isAuthenticated) {
          throw new Error('è«‹å…ˆå®Œæˆ ZKP èªè­‰');
        }

        // 2. ç”Ÿæˆ ZK Proof
        const reportData = {
          content: content,
          tags: selectedTags,
          timestamp: Date.now()
        };
        
        const proof = await window.zkpAuth.generateProof('submit_report', reportData);
        console.log('âœ… ZK Proof ç”ŸæˆæˆåŠŸ');
        
        submitBtn.textContent = 'â³ é©—è­‰ Proof...';
        
        // 3. é©—è­‰ Proof
        const isValidProof = await window.zkpAuth.verifyProof(proof);
        if (!isValidProof) {
          throw new Error('ZK Proof é©—è­‰å¤±æ•—');
        }
        
        console.log('âœ… ZK Proof é©—è­‰æˆåŠŸ');
        submitBtn.textContent = 'â³ æäº¤ä¸­...';
        
        // ä½¿ç”¨å·²é€£æ¥çš„ç•¶å‰å¸³è™Ÿ
        console.log('æäº¤æª¢èˆ‰çš„å¸³è™Ÿ:', currentAccount);
        console.log('é¸æ“‡çš„æ¨™ç±¤:', selectedTags);
        console.log('ZK Proof Nullifier:', proof.nullifierHash);
        
        // æ­¥é©Ÿ1: å¾å¾Œç«¯ç²å– CIDï¼ˆåŒ…å«æ¨™ç±¤å’Œ ZK Proofï¼‰
        const response = await fetch('http://localhost:3000/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            content: content,
            tags: selectedTags,
            zkProof: proof // åŒ…å« ZK Proof
          })
        });
        
        const data = await response.json();
        if (!data.success) throw new Error(data.error);
        
        submitBtn.textContent = 'â³ æäº¤åˆ°å€å¡Šéˆ...';
        
        // æ­¥é©Ÿ2: èª¿ç”¨æ–°çš„æ™ºèƒ½åˆç´„æ–¹æ³•ï¼ˆåŒ…å« ZKP è³‡è¨Šï¼‰
        console.log('ğŸ”— èª¿ç”¨æ™ºèƒ½åˆç´„ï¼ŒCID:', data.cid);
        console.log('ğŸ” ZKP Proof:', proof);
        
        // ä½¿ç”¨æ–°çš„ submitReportWithZKP æ–¹æ³•
        const tx = await contract.submitReportWithZKP(
          data.cid,
          proof.commitment || "",
          proof.nullifierHash || "",
          true // zkpVerified = true
        );
        console.log('ğŸ“ äº¤æ˜“å·²é€å‡º:', tx.hash);
        
        submitBtn.textContent = 'â³ ç­‰å¾…ç¢ºèª...';
        const receipt = await tx.wait();
        console.log('âœ… äº¤æ˜“ç¢ºèª:', receipt.hash);
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        const successMsg = document.createElement('div');
        successMsg.className = 'success';
        successMsg.innerHTML = `
          âœ… æª¢èˆ‰æäº¤æˆåŠŸï¼<br>
          <strong>ğŸ” ZKP ç‹€æ…‹:</strong> å·²é©—è­‰ (${proof.nullifierHash.substring(0, 8)}...)<br>
          <strong>æäº¤å¸³è™Ÿ:</strong> ${currentAccount}<br>
          <strong>é¸æ“‡æ¨™ç±¤:</strong> ${selectedTags.join(', ') || 'ç„¡'}<br>
          <strong>CID:</strong> ${data.cid}<br>
          <strong>äº¤æ˜“é›œæ¹Š:</strong> ${receipt.hash}
        `;
        reportForm.appendChild(successMsg);
        
        setTimeout(() => successMsg.remove(), 8000);
        
        // æ¸…ç©ºè¡¨å–®å’Œæ¨™ç±¤é¸æ“‡
        textarea.value = '';
        selectedTags = [];
        document.querySelectorAll('.tag-btn.selected').forEach(btn => {
          btn.classList.remove('selected');
        });
        updateSelectedTagsDisplay();
        
        // å»¶é²é‡æ–°è¼‰å…¥ä»¥ç¢ºä¿å€å¡ŠéˆåŒæ­¥
        setTimeout(async () => {
          await loadHistory();
        }, 2000);
        
      } catch (err) {
        console.error('æäº¤éŒ¯èª¤:', err);
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error';
        errorMsg.innerHTML = `
          âŒ æäº¤å¤±æ•—: ${err.message}<br>
          <small>è«‹ç¢ºä¿ MetaMask å·²é€£æ¥ä¸”å¸³è™Ÿæœ‰è¶³å¤ çš„æ¸¬è©¦å¹£</small>
        `;
        reportForm.appendChild(errorMsg);
        
        setTimeout(() => errorMsg.remove(), 8000);
        
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ é€å‡ºæª¢èˆ‰';
      }
    });

    // æ›´æ–°ç¯©é¸æŒ‰éˆ•
    function updateFilterButtons() {
      const allTags = new Set();
      currentReports.forEach(report => {
        if (report.tags && report.tags.length > 0) {
          report.tags.forEach(tag => allTags.add(tag));
        }
      });

      let buttonsHtml = '<button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>';
      allTags.forEach(tag => {
        buttonsHtml += `<button class="filter-btn" data-filter="${tag}">${tag}</button>`;
      });

      filterButtonsEl.innerHTML = buttonsHtml;

      // æ·»åŠ ç¯©é¸æŒ‰éˆ•äº‹ä»¶ç›£è½
      filterButtonsEl.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // ç§»é™¤æ‰€æœ‰ active é¡
          filterButtonsEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          // æ·»åŠ  active é¡åˆ°ç•¶å‰æŒ‰éˆ•
          btn.classList.add('active');
          
          currentFilter = btn.dataset.filter;
          updateReportsDisplay();
        });
      });
    }

    // ç¯©é¸æª¢èˆ‰è¨˜éŒ„
    function filterReports() {
      if (currentFilter === 'all') {
        return currentReports;
      }
      
      return currentReports.filter(report => 
        report.tags && report.tags.includes(currentFilter)
      );
    }

    // é€£æ¥ MetaMask
  })();
  </script>
</body>
</html>
